<html>
  <head>
    <meta charset="utf-8">
    <title>ç™¾åº¦åœ°å›¾ API è¦†ç›–ç‚¹å¹³ç§»</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.3, user-scalable=no">
    <meta name="description" content="ç™¾åº¦åœ°å›¾ API è¦†ç›–ç‚¹å¹³ç§»">
    <meta name="author" content="yaner">
    <style>
        html,body,#map{
            height: 100%;
            width: 100%;
            margin: 0;
        }
        #map{
            height: 90%;
        }
        #buttons {
          display: flex;
          justify-content: space-between;
          width: 400px;
          margin: 12px auto;
        }
        #stop, #play, #replay, #type {
          cursor: pointer;
          height: 34px;
          line-height: 34px;
          border-radius: 2px;
          background-color: #5298ff;
          color: #fff;
          padding: 0 12px;
        }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=FCCAtTiReIsYlxZ7e113GKnsaPuWzxhN"></script>
  </head>
  <body>
    <div id="map"></div>
    <div id="buttons">
      <div id="stop">æš‚åœ</div>   
      <div id="play">æ’­æ”¾</div>   
      <div id="replay">é‡æ–°æ’­æ”¾</div> 
      <div id="type">çº¿æ¡æ·»åŠ æ–¹å‘</div>
    </div>    
    <script>
      var data = [
        {
            "id": 3607,
            "latitude": "30.29038078067957",
            "longitude": "120.00749168359494",
            "recordDate": "2022-04-20T17:49:18.000+0800"
        },
        {
            "id": 3678,
            "latitude": "30.290288267894883",
            "longitude": "120.00754817005249",
            "recordDate": "2022-04-20T18:29:32.000+0800"
        },
        {
            "id": 3683,
            "latitude": "30.290270210846124",
            "longitude": "120.00743910387077",
            "recordDate": "2022-04-20T18:31:15.000+0800"
        },
        {
            "id": 3685,
            "latitude": "30.290333152914947",
            "longitude": "120.00742006760488",
            "recordDate": "2022-04-20T18:31:49.000+0800"
        },
        {
            "id": 3688,
            "latitude": "30.290493060347043",
            "longitude": "120.00608602738974",
            "recordDate": "2022-04-20T18:32:58.000+0800"
        },
        {
            "id": 3690,
            "latitude": "30.29036182117118",
            "longitude": "120.00665414361747",
            "recordDate": "2022-04-20T18:33:31.000+0800"
        },
        {
            "id": 3694,
            "latitude": "30.2904627316243",
            "longitude": "120.00656319580074",
            "recordDate": "2022-04-20T18:34:33.000+0800"
        },
        {
            "id": 3696,
            "latitude": "30.290647876598843",
            "longitude": "120.0052785061591",
            "recordDate": "2022-04-20T18:35:04.000+0800"
        }
      ]
      var map = new BMap.Map("map");
      map.enableScrollWheelZoom(true);
      map.centerAndZoom(new BMap.Point(data[2].longitude, data[2].latitude), 20);
      var points = getPoints(data); // è·å–dataæ•°æ®ä¸­çš„ç»çº¬åº¦ç‚¹å¹¶æ ¼å¼åŒ–ç‚¹ä¸ºBMapç‚¹

      var allPoints = [];
      for(var i = 1; i < points.length; i++){ // å°†æ‰€æœ‰çš„ç‚¹åˆ†å‰²ä¸ºnä¸ªå°ç‚¹, ç”¨äºç§»åŠ¨è¿‡åº¦åŠ¨ç”»              
          allPoints.push.apply(allPoints,getPoins(points[i-1],points[i],500));
      }

      var icon = new BMap.Icon("https://fe-cloud.uni-ubi.com/image/1639107532109-bluePoint.png?x-oss-process=img/q/80",new BMap.Size(16,16)); // ç§»åŠ¨ç‚¹icon
      var mkrPoint =new BMap.Marker(allPoints[0], { icon: icon}); // ç§»åŠ¨çš„ç‚¹


      /** æœ‰æ–¹å‘çš„çº¿æ¡  ğŸ‘‡ **/
      var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {
        scale: 0.6,//å›¾æ ‡ç¼©æ”¾å¤§å°
        strokeColor:'#fff',//è®¾ç½®çŸ¢é‡å›¾æ ‡çš„çº¿å¡«å……é¢œè‰²
        strokeWeight: '1',//è®¾ç½®çº¿å®½
      });
      var icons = new BMap.IconSequence(sy, '3', '50');
      var directionPolyline =new BMap.Polyline(points, {
        enableEditing: false,//æ˜¯å¦å¯ç”¨çº¿ç¼–è¾‘ï¼Œé»˜è®¤ä¸ºfalse
        enableClicking: true,//æ˜¯å¦å“åº”ç‚¹å‡»äº‹ä»¶ï¼Œé»˜è®¤ä¸ºtrue
        icons:[icons],
        strokeWeight:'6',//æŠ˜çº¿çš„å®½åº¦ï¼Œä»¥åƒç´ ä¸ºå•ä½
        strokeOpacity: 1 ,//æŠ˜çº¿çš„é€æ˜åº¦ï¼Œå–å€¼èŒƒå›´0 - 1
        strokeColor:"#5298ff" //æŠ˜çº¿é¢œè‰²
      });
      /** æœ‰æ–¹å‘çš„çº¿æ¡  ğŸ‘† **/

      /** æ™®é€šçº¿æ¡  ğŸ‘‡ **/
      var polyline = new BMap.Polyline(points, {strokeColor:"#5298ff", strokeWeight:3, strokeOpacity:0.8}); 
      map.addOverlay(polyline); 
      /** æ™®é€šçº¿æ¡  ğŸ‘† **/

      addMarker('start',points[0]); // è®¾ç½®èµ·ç‚¹
      addMarker('end',points[points.length - 1]); // è®¾ç½®ç»ˆç‚¹


      move(allPoints,points); //å‚æ•°ï¼šallPointsåˆ†å‰²ç‚¹ã€pointså®é™…æ•°æ®ç‚¹ï¼Œ æ‰§è¡ŒåŠ¨ç”»

      /**
      *æ·»åŠ èµ·ç‚¹ã€ç»ˆç‚¹
      *@param type ç±»å‹ï¼Œèµ·ç‚¹startã€ç»ˆç‚¹end
      *@param point BMapç»çº¬ç‚¹
      */
      function addMarker(type,point){
          if(type == "start"){
              var icon01 = new BMap.Icon("https://fe-cloud.uni-ubi.com/image/1646031203574-device_point_2.png?x-oss-process=img/q/80",new BMap.Size(24,38),{anchor: new BMap.Size(16,28)});
              var mkr01 =new BMap.Marker(point, { icon: icon01});
              map.addOverlay(mkr01); 
          }else if(type == "end"){
              var icon02 = new BMap.Icon("https://fe-cloud.uni-ubi.com/image/1646029742276-device_point.png?x-oss-process=img/q/80",new BMap.Size(24,38),{anchor: new BMap.Size(16,28)});
              var mkr02 =new BMap.Marker(point, { icon: icon02});
              map.addOverlay(mkr02);
          }
      }


      /**
      *è·å–dataæ•°æ®ä¸­çš„ç»çº¬åº¦ç‚¹å¹¶æ ¼å¼åŒ–ç‚¹ä¸ºBMapç‚¹
      *@param dataæ•°æ®
      *@return points BMapç»çº¬ç‚¹æ•°ç»„
      */
      function getPoints(data){
          var points = [];
          for (var i = 0; i < data.length; i++) {
              var x = data[i].longitude;
              var y = data[i].latitude;
              points[i] = new BMap.Point(x,y);

          }
          return points;
      }


      /**
      *è·å–prvePointå’ŒnewPointä¹‹é—´çš„numä¸ªç‚¹
      *@param prvePoint èµ·ç‚¹
      *@param newPoint ç»ˆç‚¹
      *@param num å–ä¸¤ä¸­é—´çš„ç‚¹ä¸ªæ•°
      *@return points ä¸¤ç‚¹ä¹‹é—´çš„numä¸ªç‚¹çš„æ•°ç»„   
      */
      function getPoins(prvePoint,newPoint,num){
          var lat ;
          var lng ;
          var points = [];
          if(prvePoint.lng>newPoint.lng&&prvePoint.lat>newPoint.lat){         
              lat = Math.abs(prvePoint.lat-newPoint.lat)/num;
              lng = Math.abs(prvePoint.lng-newPoint.lng)/num;
              points[0] = prvePoint;
              for(var i = 1;i<num-1;i++){
                  points[i] = new BMap.Point(prvePoint.lng-lng*(i+1),prvePoint.lat-lat*(i+1)); 
              }
          }
          if(prvePoint.lng>newPoint.lng&&prvePoint.lat<newPoint.lat){         
              lat = Math.abs(prvePoint.lat-newPoint.lat)/num;
              lng = Math.abs(prvePoint.lng-newPoint.lng)/num;
              points[0] = prvePoint;
              for(var i = 1;i<num-1;i++){
                  points[i] = new BMap.Point(prvePoint.lng-lng*(i+1),prvePoint.lat+lat*(i+1)); 
              }
          }
          if(prvePoint.lng<newPoint.lng&&prvePoint.lat>newPoint.lat){         
              lat = Math.abs(prvePoint.lat-newPoint.lat)/num;
              lng = Math.abs(prvePoint.lng-newPoint.lng)/num;
              points[0] = prvePoint;
              for(var i = 1;i<num-1;i++){
                  points[i] = new BMap.Point(prvePoint.lng+lng*(i+1),prvePoint.lat-lat*(i+1)); 
              }
          }
          if(prvePoint.lng<newPoint.lng&&prvePoint.lat<newPoint.lat){         
              lat = Math.abs(prvePoint.lat-newPoint.lat)/num;
              lng = Math.abs(prvePoint.lng-newPoint.lng)/num;
              points[0] = prvePoint;
              for(var i = 1;i<num-1;i++){
                  points[i] = new BMap.Point(prvePoint.lng+lng*(i+1),prvePoint.lat+lat*(i+1)); 
              }
          }

          return points;
      }



      /** é¡µé¢æŒ‰é’®äº¤äº’  ğŸ‘‡ **/
      var stopDom = document.getElementById('stop')
      var playDom = document.getElementById('play')
      var replayDom = document.getElementById('replay')
      var typeDom = document.getElementById('type')

      var stopFlag = false // æš‚åœæ ‡è¯†
      var playI = 0 // å½“å‰æ’­æ”¾è‡³çš„allPointsä½ç½®
      var playJ = 0 // å½“å‰æ’­æ”¾è‡³çš„pointsä½ç½®

      stopDom.addEventListener("click",stopFun); // æš‚åœ
      function stopFun(){
        stopFlag = true            
      }
      playDom.addEventListener("click",playFun); // æ’­æ”¾
      function playFun(){
        stopFlag = false  
        move(allPoints,points);
      }
      replayDom.addEventListener("click",replayFun); // é‡æ–°æ’­æ”¾
      function replayFun(){
        stopFlag = true 
        setTimeout(() => {
          stopFlag = false  
          playI = 0
          playJ = 0
          move(allPoints,points);//å‚æ•°ï¼šallPointsåˆ†å‰²ç‚¹ã€pointså®é™…æ•°æ®ç‚¹ã€æ¯ä¸ªç‚¹çš„æ—¶é—´å·®ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰
        }, 100)
      }
      typeDom.addEventListener("click",typeChangeFun); // åˆ‡æ¢æœ‰æ–¹å‘çš„çº¿æ¡
      function typeChangeFun(){
        stopFlag = true 
        setTimeout(() => {
          stopFlag = false  
          playI = 0
          playJ = 0
          map.addOverlay(directionPolyline);
          move(allPoints,points);//å‚æ•°ï¼šallPointsåˆ†å‰²ç‚¹ã€pointså®é™…æ•°æ®ç‚¹ã€æ¯ä¸ªç‚¹çš„æ—¶é—´å·®ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰
        }, 100)
      }
      /** é¡µé¢æŒ‰é’®äº¤äº’  ğŸ‘† **/



      /**
      *@param allPoints æ‰“æ•£åçš„ä¸€ä¸ªä¸ªç‚¹çš„æ•°ç»„
      *@param points åˆå§‹çš„ä½ç½®æ•°ç»„
      *@param time ä½ç½®ä¸ä¸‹ä¸€ä¸ªä½ç½®ç§»åŠ¨çš„æ—¶é—´
      */
      function move(allPoints,points,time = 0.01){
          map.addOverlay(mkrPoint); // æ·»åŠ ç§»åŠ¨çš„æ ‡è®°ç‚¹
          var paths = allPoints.length;  // è·å¾—æœ‰å‡ ä¸ªç‚¹
          var j = playJ || 0; // æš‚åœæ—¶ç‚¹å‡»æ’­æ”¾ä»æš‚åœçš„ä½ç½®æ’­æ”¾
          var i = playI || 0; // æš‚åœæ—¶ç‚¹å‡»æ’­æ”¾ä»æš‚åœçš„ä½ç½®æ’­æ”¾
          function resetMkPoint(i){
              if (stopFlag) { // æš‚åœæ—¶ï¼Œå¾—åˆ°å½“å‰è¡Œèµ°åˆ°çš„ä½ç½®
                playJ = j;
                playI = i;
                return
              }
              if(mkrPoint.getPosition().lng == points[j].lng && mkrPoint.getPosition().lat == points[j].lat){ // å½“æ‰§è¡Œåˆ°dataçš„ä½ç½®æ—¶ï¼Œè¦å°†j+1
                  j++;
              }
              mkrPoint.setPosition(allPoints[i]);
              if(i < paths && !stopFlag){
                  playI = i
                  setTimeout(function(){
                      i++;
                      resetMkPoint(i);
                  }, time);
              } else {
                  // è®¾ç½®ä½ç½®ä¸º0ï¼Œä»¥ä¾¿æš‚åœåæ’­æ”¾å¯ä»å¤´æ’­æ”¾
                playJ = 0;
                playI = 0;
              }
          }
          setTimeout(function(){
              resetMkPoint(i);
          }, time)
      }
    </script>
  </body>
</html>